# 要件定義書

## 概要

この仕様書は、bookmark2obsidianアプリケーションのパフォーマンス改善とUI表示問題の修正要件を定義します。現在のアプリケーションは4000件程度のブックマーク解析に90秒かかり、ログ表示や結果表示に問題があります。また、解析結果のキャッシュ機能が不足しています。

## 要件

### 要件1: ブックマーク解析パフォーマンスの改善

**ユーザーストーリー:** ユーザーとして、ブックマークファイルの解析を高速で実行したい。そうすることで、4000件程度のブックマークでも待ち時間を大幅に短縮できる。

#### 受け入れ基準

1. WHEN ユーザーが4000件程度のブックマークファイルをアップロードした時 THEN システムは解析時間を現在の90秒から30秒以下に短縮すること
2. WHEN ブックマーク解析を実行する時 THEN システムは並列処理やバッチ処理を活用して処理効率を向上させること
3. WHEN 大量のブックマークを処理する時 THEN システムはメモリ使用量を最適化して安定した動作を維持すること
4. WHEN 解析処理中 THEN システムは進捗状況をリアルタイムで表示すること

### 要件2: ログ表示の修正

**ユーザーストーリー:** ユーザーとして、処理ログが正しく改行されて表示されることを望む。そうすることで、処理状況を読みやすい形で確認できる。

#### 受け入れ基準

1. WHEN システムが処理ログを画面に表示する時 THEN `\n`文字が適切に改行として表示されること
2. WHEN ログメッセージに改行文字が含まれる時 THEN エスケープされずに正しい改行として処理されること
3. WHEN 複数行のログメッセージを表示する時 THEN 各行が適切に分離されて表示されること
4. WHEN ログ表示を更新する時 THEN Streamlitの適切なコンポーネントを使用して改行を処理すること

### 要件3: 解析結果表示の修正

**ユーザーストーリー:** ユーザーとして、ブックマーク解析完了後に結果一覧とプレビューが正しく表示されることを望む。そうすることで、処理結果を確認して次のステップに進むことができる。

#### 受け入れ基準

1. WHEN ブックマーク解析が完了した時 THEN システムはブックマーク一覧を画面に表示すること
2. WHEN 解析結果が利用可能になった時 THEN システはプレビュー機能を正常に動作させること
3. WHEN ユーザーがブックマーク項目をクリックした時 THEN システムは対応するプレビューを表示すること
4. WHEN 表示エラーが発生した時 THEN システムは適切なエラーメッセージを表示して原因を特定できるようにすること

### 要件4: 解析結果のキャッシュ機能

**ユーザーストーリー:** ユーザーとして、一度解析したブックマークファイルとディレクトリの結果を保存・再利用したい。そうすることで、同じファイルを再度解析する必要がなくなり、作業効率が向上する。

#### 受け入れ基準

1. WHEN ブックマーク解析が完了した時 THEN システムは解析結果をローカルストレージに保存すること
2. WHEN ローカルディレクトリ解析が完了した時 THEN システムはディレクトリ構造をローカルストレージに保存すること
3. WHEN ユーザーが同じファイルを再度アップロードした時 THEN システムは保存された結果を検出して再利用を提案すること
4. WHEN キャッシュされた結果が利用可能な時 THEN システムは新規解析をスキップして保存された結果を表示すること
5. WHEN ユーザーがキャッシュをクリアしたい時 THEN システムは履歴リセットボタンを提供すること

### 要件5: キャッシュ管理機能

**ユーザーストーリー:** ユーザーとして、保存されたキャッシュデータを管理したい。そうすることで、古いデータを削除したり、強制的に再解析を実行したりできる。

#### 受け入れ基準

1. WHEN ユーザーがキャッシュ状況を確認したい時 THEN システムは保存されているキャッシュの一覧を表示すること
2. WHEN ユーザーが履歴リセットボタンをクリックした時 THEN システムはすべてのキャッシュデータを削除すること
3. WHEN ユーザーが強制再解析を選択した時 THEN システムはキャッシュを無視して新規解析を実行すること
4. WHEN キャッシュデータが破損している時 THEN システムは自動的に新規解析にフォールバックすること

### 要件6: 進捗表示の改善

**ユーザーストーリー:** ユーザーとして、長時間の処理中に詳細な進捗状況を確認したい。そうすることで、処理が正常に進行していることを把握できる。

#### 受け入れ基準

1. WHEN 解析処理が開始された時 THEN システムは進捗バーを表示すること
2. WHEN 処理が進行中 THEN システムは現在の処理段階と完了率を表示すること
3. WHEN 各処理段階が完了した時 THEN システムは処理時間と処理件数を表示すること
4. WHEN エラーが発生した時 THEN システムは進捗表示にエラー情報を含めること

### 要件7: エラーハンドリングの強化

**ユーザーストーリー:** ユーザーとして、処理中に発生したエラーの詳細を把握したい。そうすることで、問題の原因を理解して適切に対処できる。

#### 受け入れ基準

1. WHEN 表示関連のエラーが発生した時 THEN システムは具体的なエラーメッセージとスタックトレースを記録すること
2. WHEN キャッシュ関連のエラーが発生した時 THEN システムは自動的に新規処理にフォールバックすること
3. WHEN パフォーマンス問題が検出された時 THEN システムは警告メッセージを表示すること
4. WHEN 致命的なエラーが発生した時 THEN システムはユーザーに分かりやすいエラーメッセージを表示すること