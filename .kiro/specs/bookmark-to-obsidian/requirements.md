# 要件定義書

## はじめに

このアプリケーションは、Google Chromeのbookmarks.htmlファイルを解析し、ブックマークされたWebページの内容を取得して、Obsidian用のMarkdownファイルとしてローカルに保存するStreamlitベースのデスクトップアプリケーションです。ユーザーのローカル環境で動作し、既存のディレクトリ構造を維持しながら、重複を避けて効率的にコンテンツを管理できます。

## 要件

### 要件1

**ユーザーストーリー:** ユーザーとして、bookmarks.htmlファイルをアップロードし、保存先ディレクトリを指定したい。そうすることで、ブックマークの処理を開始できる。

#### 受入基準

1. WHEN ユーザーがStreamlitアプリを起動する THEN システムはファイルアップロード機能とディレクトリ選択機能を表示する
2. WHEN ユーザーがbookmarks.htmlファイルをアップロードする THEN システムはファイルの妥当性を検証し、受け入れる
3. WHEN ユーザーがローカルディレクトリを指定する THEN システムは指定されたパスの存在を確認し、アクセス権限を検証する

### 要件2

**ユーザーストーリー:** システムとして、bookmarks.htmlとローカルディレクトリの構造を解析したい。そうすることで、重複チェックと処理対象の特定ができる。

#### 受入基準

1. WHEN システムがbookmarks.htmlを受け取る THEN システムは`<a>`タグからURL、ページ名、ディレクトリ階層を抽出する
2. WHEN システムがローカルディレクトリを読み取る THEN システムは既存のファイル名とディレクトリ構造を一覧化する
3. WHEN システムが両方の構造を比較する THEN システムは同階層に同名ファイルが存在するページを除外リストに追加する
4. IF URLがドメインのルートである THEN システムはそのURLを除外リストに追加する

### 要件3

**ユーザーストーリー:** システムとして、Webページの内容を適切に取得したい。そうすることで、質の高いMarkdownコンテンツを生成できる。

#### 受入基準

1. WHEN システムがURL一覧を処理する THEN システムはドメインごとにグループ化し、適切な待ち時間を設ける
2. WHEN システムがWebページにアクセスする THEN システムはrobots.txtを確認し、スクレイピングが許可されている場合のみ処理を続行する
3. WHEN システムがHTMLを取得する THEN システムは記事本文の存在を検証し、取得できない場合は除外リストに追加する
4. WHEN システムが記事本文を抽出する THEN システムは本文とタグ情報のみを抽出し、不要な要素を除去する

### 要件4

**ユーザーストーリー:** システムとして、Obsidian形式のMarkdownを生成したい。そうすることで、ユーザーがObsidianで直接利用できるファイルを提供できる。

#### 受入基準

1. WHEN システムが記事内容を処理する THEN システムはObsidian形式のヘッダ情報（YAML front matter）を含むMarkdownを生成する
2. WHEN システムがMarkdownを作成する THEN システムは元のブックマーク階層構造を維持したファイルパスを設定する
3. WHEN システムがタグ情報を処理する THEN システムはObsidianのタグ形式（#タグ名）に変換する

### 要件5

**ユーザーストーリー:** ユーザーとして、処理対象ページを確認し、選択的に除外したい。そうすることで、不要なページの保存を避けることができる。

#### 受入基準

1. WHEN システムが処理対象を特定する THEN システムは展開可能なディレクトリツリー形式でページ一覧を表示する
2. WHEN ユーザーがページ名をクリックする THEN システムはそのページのプレビューを表示する
3. WHEN ユーザーがチェックボックスを操作する THEN システムは該当ページの処理対象状態を更新する（デフォルト：チェック済み）
4. WHEN ユーザーが「保存」ボタンを押す THEN システムはチェックされたページのみをMarkdownファイルとして保存する

### 要件6

**ユーザーストーリー:** システムとして、エラーハンドリングと進捗表示を適切に行いたい。そうすることで、ユーザーに安心して利用してもらえる。

#### 受入基準

1. WHEN システムがWebページアクセスでエラーが発生する THEN システムはエラーログを記録し、該当ページを除外して処理を継続する
2. WHEN システムが大量のページを処理する THEN システムは進捗バーまたは処理状況を表示する
3. WHEN システムがファイル保存でエラーが発生する THEN システムはエラーメッセージを表示し、ユーザーに対処方法を提示する
4. IF ネットワーク接続に問題がある THEN システムは適切なエラーメッセージを表示し、リトライオプションを提供する